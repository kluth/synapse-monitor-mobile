name: CI/CD Pipeline

on:
  push:
    branches: [main, develop, 'claude/**']
    paths:
      - 'lib/**'
      - 'test/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - 'analysis_options.yaml'
      - '.github/workflows/ci.yml'
      - 'android/**'
      - 'ios/**'
      - 'web/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'lib/**'
      - 'test/**'
      - 'pubspec.yaml'
      - 'pubspec.lock'
      - 'analysis_options.yaml'
      - '.github/workflows/ci.yml'
      - 'android/**'
      - 'ios/**'
      - 'web/**'
  workflow_dispatch:

# Cancel in-progress runs for the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' }}

env:
  FLUTTER_VERSION: '3.24.0'
  FLUTTER_CHANNEL: 'stable'
  JAVA_VERSION: '17'

jobs:
  # ============================================================================
  # JOB 1: Code Quality & Analysis
  # ============================================================================
  code-quality:
    name: Code Quality & Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Flutter SDK
        uses: actions/checkout@v4
        with:
          repository: 'flutter/flutter'
          ref: ${{ env.FLUTTER_VERSION }}
          path: 'flutter-sdk'

      - name: ğŸ“¦ Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            flutter-sdk
            ~/.pub-cache
          key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-
            ${{ runner.os }}-flutter-

      - name: âš™ï¸ Add Flutter to PATH
        run: |
          echo "$GITHUB_WORKSPACE/flutter-sdk/bin" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/flutter-sdk/bin/cache/dart-sdk/bin" >> $GITHUB_PATH

      - name: ğŸ” Flutter doctor
        run: flutter doctor -v

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ” Verify pubspec.lock is up to date
        run: |
          if git diff --exit-code pubspec.lock; then
            echo "âœ… pubspec.lock is up to date"
          else
            echo "âŒ pubspec.lock is out of date. Run 'flutter pub get' and commit changes."
            exit 1
          fi

      - name: ğŸ¨ Check code formatting
        run: dart format --output=none --set-exit-if-changed .

      - name: ğŸ” Analyze code
        run: flutter analyze --fatal-infos --fatal-warnings

      - name: ğŸ“Š Check code metrics
        run: |
          flutter pub global activate dart_code_metrics
          flutter pub global run dart_code_metrics:metrics analyze lib --reporter=console

      - name: ğŸ”’ Check for unused dependencies
        run: |
          flutter pub global activate dependency_validator
          flutter pub global run dependency_validator:dependency_validator

  # ============================================================================
  # JOB 2: Code Generation Verification
  # ============================================================================
  code-generation:
    name: Code Generation Check
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: âš™ï¸ Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ” Check for uncommitted generated files
        run: |
          if git diff --exit-code; then
            echo "âœ… All generated files are up to date"
          else
            echo "âŒ Generated files are out of date. Run 'dart run build_runner build' and commit changes."
            git diff
            exit 1
          fi

  # ============================================================================
  # JOB 3: Unit & Widget Tests
  # ============================================================================
  test:
    name: Tests (Unit & Widget)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: âš™ï¸ Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ§ª Run all tests with coverage
        run: flutter test --coverage --reporter expanded

      - name: ğŸ“¦ Cache lcov
        uses: actions/cache@v4
        with:
          path: |
            /usr/bin/lcov
            /usr/bin/genhtml
          key: lcov-${{ runner.os }}-1.15

      - name: ğŸ“¦ Install lcov if needed
        run: |
          if [ ! -f /usr/bin/lcov ]; then
            sudo apt-get update
            sudo apt-get install -y lcov
          else
            echo "lcov already installed (from cache)"
          fi

      - name: ğŸ“Š Check test coverage threshold
        run: |
          lcov --summary coverage/lcov.info > coverage_summary.txt
          COVERAGE=$(grep -oP 'lines......: \K[0-9.]+' coverage_summary.txt)
          echo "Test coverage: $COVERAGE%"
          THRESHOLD=85.0
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "âŒ Coverage $COVERAGE% is below threshold $THRESHOLD%"
            exit 1
          else
            echo "âœ… Coverage $COVERAGE% meets threshold $THRESHOLD%"
          fi

      - name: ğŸ“Š Generate coverage HTML report
        if: always()
        run: genhtml coverage/lcov.info -o coverage/html

      - name: ğŸ“¤ Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/html
          retention-days: 30

  # ============================================================================
  # JOB 4: Security Scanning
  # ============================================================================
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      security-events: write
      contents: read

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter SDK
        uses: actions/checkout@v4
        with:
          repository: 'flutter/flutter'
          ref: ${{ env.FLUTTER_VERSION }}
          path: 'flutter-sdk'

      - name: âš™ï¸ Add Flutter to PATH
        run: |
          echo "$GITHUB_WORKSPACE/flutter-sdk/bin" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/flutter-sdk/bin/cache/dart-sdk/bin" >> $GITHUB_PATH

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ”’ Check for outdated/vulnerable packages
        run: flutter pub outdated --json > outdated.json || true

      - name: ğŸ”’ Download OSV Scanner
        run: |
          curl -L https://github.com/google/osv-scanner/releases/download/v1.4.3/osv-scanner_1.4.3_linux_amd64 -o osv-scanner
          chmod +x osv-scanner

      - name: ğŸ” Run OSV vulnerability scan
        run: ./osv-scanner --lockfile=pubspec.lock --format=json > osv-results.json || true

      - name: ğŸ“Š Analyze dependencies
        run: |
          flutter pub global activate pana
          flutter pub global run pana --no-warning --json > pana-results.json || true

  # ============================================================================
  # JOB 5: Build Android
  # ============================================================================
  build-android:
    name: Build Android (APK & AAB)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [code-quality, test]
    if: github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ğŸ”§ Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: âš™ï¸ Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ—ï¸ Build APK (Debug)
        run: flutter build apk --debug

      - name: ğŸ—ï¸ Build APK (Release)
        if: github.ref == 'refs/heads/main'
        run: flutter build apk --release

      - name: ğŸ—ï¸ Build App Bundle (Release)
        if: github.ref == 'refs/heads/main'
        run: flutter build appbundle --release

      - name: ğŸ“¤ Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 30

      - name: ğŸ“¤ Upload AAB artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/**/*.aab
          retention-days: 30

  # ============================================================================
  # JOB 6: Build iOS
  # ============================================================================
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    timeout-minutes: 45
    needs: [code-quality, test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: âš™ï¸ Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ“¦ Install CocoaPods
        run: |
          cd ios
          pod install
          cd ..

      - name: ğŸ—ï¸ Build iOS (No Codesign)
        run: flutter build ios --release --no-codesign

  # ============================================================================
  # JOB 7: Build Web
  # ============================================================================
  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [code-quality, test]
    if: github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: âš™ï¸ Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ—ï¸ Build Web
        run: flutter build web --release --web-renderer canvaskit

      - name: ğŸ“¤ Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 30

  # ============================================================================
  # JOB 8: Build Desktop (Windows, macOS, Linux)
  # ============================================================================
  build-desktop:
    name: Build Desktop (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    needs: [code-quality, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: windows

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter SDK
        uses: actions/checkout@v4
        with:
          repository: 'flutter/flutter'
          ref: ${{ env.FLUTTER_VERSION }}
          path: 'flutter-sdk'

      - name: ğŸ“¦ Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            flutter-sdk
            ~/.pub-cache
          key: ${{ runner.os }}-flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}

      - name: âš™ï¸ Add Flutter to PATH (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "$GITHUB_WORKSPACE/flutter-sdk/bin" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/flutter-sdk/bin/cache/dart-sdk/bin" >> $GITHUB_PATH

      - name: âš™ï¸ Add Flutter to PATH (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "$env:GITHUB_WORKSPACE\flutter-sdk\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "$env:GITHUB_WORKSPACE\flutter-sdk\bin\cache\dart-sdk\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: ğŸ”§ Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: âš™ï¸ Run code generation
        run: dart run build_runner build --delete-conflicting-outputs

      - name: ğŸ—ï¸ Build Desktop
        run: flutter build ${{ matrix.platform }} --release

      - name: ğŸ“¤ Upload desktop artifact
        uses: actions/upload-artifact@v4
        with:
          name: desktop-${{ matrix.platform }}
          path: build/${{ matrix.platform }}
          retention-days: 30

  # ============================================================================
  # JOB 9: Documentation Generation
  # ============================================================================
  documentation:
    name: Generate Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Flutter SDK
        uses: actions/checkout@v4
        with:
          repository: 'flutter/flutter'
          ref: ${{ env.FLUTTER_VERSION }}
          path: 'flutter-sdk'

      - name: âš™ï¸ Add Flutter to PATH
        run: |
          echo "$GITHUB_WORKSPACE/flutter-sdk/bin" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/flutter-sdk/bin/cache/dart-sdk/bin" >> $GITHUB_PATH

      - name: ğŸ“¦ Get dependencies
        run: flutter pub get

      - name: ğŸ“š Generate documentation
        run: dart doc .

      - name: ğŸ“¤ Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: doc/api
          retention-days: 90

      - name: ğŸš€ Setup GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: actions/configure-pages@v4

      - name: ğŸ“¦ Upload Pages artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./doc/api

      - name: ğŸš€ Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: actions/deploy-pages@v4

  # ============================================================================
  # JOB 10: Status Summary & Sentinel Check
  # ============================================================================
  # This job serves as the single required status check for branch protection.
  # It aggregates all critical jobs and fails if any required check fails.
  all-checks-complete:
    name: All Required Checks Complete
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Only depend on truly required jobs that always run
    needs: [code-quality, code-generation, test, security]
    if: always()

    steps:
      - name: ğŸ“Š Check all required jobs
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = {
              'Code Quality': '${{ needs.code-quality.result }}',
              'Code Generation': '${{ needs.code-generation.result }}',
              'Tests': '${{ needs.test.result }}',
              'Security': '${{ needs.security.result }}'
            };

            let summary = '# ğŸš€ CI Pipeline Status\n\n## Required Checks\n';
            let allPassed = true;

            for (const [name, result] of Object.entries(jobs)) {
              const icon = result === 'success' ? 'âœ…' : result === 'failure' ? 'âŒ' : 'âš ï¸';
              summary += `- ${icon} ${name}: ${result}\n`;
              if (result !== 'success') {
                allPassed = false;
              }
            }

            summary += '\n## Commit Info\n';
            summary += `- Branch: ${{ github.ref_name }}\n`;
            summary += `- Commit: ${{ github.sha }}\n`;
            summary += `- Author: ${{ github.actor }}\n`;

            if (allPassed) {
              summary += '\nâœ… **All required checks passed!**\n';
            } else {
              summary += '\nâŒ **One or more required checks failed.**\n';
            }

            await core.summary.addRaw(summary).write();

            // Fail this job if any required check failed
            if (!allPassed) {
              core.setFailed('One or more required checks failed');
            }
